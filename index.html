<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <title>SANKEY Exp</title>
  </head>
  <body>
    <div class="main">
      <div class="details-container">
        <div class="details">
          <h1>Sankey Chart</h1>
          <p>Created by Umair Ul Islam</p>
          <p>
            I created this Sankey chart using D3.js, inspired by the chart image
            from the
            <a href="https://www.appeconomyinsights.com/p/nvidia-full-throttle"
              >link</a
            >
            provided in the email. The data values are stored in a CSV file
            based on the image. The chart is interactive as well, you can drag
            the nodes vertically. I can refine it further by referring to the
            D3.js documentation, but this should give you an idea of my work.<br />Let
            me know if this works!
          </p>
          <img src="./chart.jpg" alt="chart-image" class="chart-image" />
        </div>
      </div>
      <div class="chart-container" id="sankey-container"></div>
    </div>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="sankey.js"></script>
    <script>
      var units = "B";
      var margin = { top: 10, right: 10, bottom: 10, left: 10 };
      var width =
        (innerWidth < 451 ? 300 : innerWidth < 1024 ? 500 : 700) -
        margin.left -
        margin.right;
      var height = 300 - margin.top - margin.bottom;

      var formatNumber = d3.format(",.0f"); // zero decimal places
      var format = function (d) {
        return formatNumber(d) + " " + units;
      };
      var color = d3.scaleOrdinal(d3.schemeCategory10);

      var svg = d3
        .select("#sankey-container")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var sankey = d3
        .sankey()
        .nodeWidth(36)
        .nodePadding(40)
        .size([width, height]);

      var path = sankey.link();

      d3.csv("test.csv", function (error, data) {
        graph = { nodes: [], links: [] };

        data.forEach(function (d) {
          graph.nodes.push({ name: d.source });
          graph.nodes.push({ name: d.target });
          graph.links.push({
            source: d.source,
            target: d.target,
            value: +d.value,
          });
        });
        // console.log(graph.nodes, graph.links);

        graph.nodes = d3.keys(
          d3
            .nest()
            .key(function (d) {
              return d.name;
            })
            .object(graph.nodes)
        );

        console.log(graph.nodes);
        console.log(graph.links);

        graph.links.forEach(function (d, i) {
          graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
          graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
        });
        graph.nodes.forEach(function (d, i) {
          graph.nodes[i] = { name: d };
        });
        console.log(graph.nodes);
        sankey.nodes(graph.nodes).links(graph.links).layout(32);

        var link = svg
          .append("g")
          .selectAll(".link")
          .data(graph.links)
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("d", path)
          .style("stroke-width", function (d) {
            return Math.max(1, d.dy);
          })
          .sort(function (a, b) {
            return b.dy - a.dy;
          });
        console.log(link);
        link.append("title").text(function (d) {
          return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value);
        });

        var node = svg
          .append("g")
          .selectAll(".node")
          .data(graph.nodes)
          .enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
          })
          .call(
            d3
              .drag()
              .subject(function (d) {
                return d;
              })
              .on("start", function () {
                this.parentNode.appendChild(this);
              })
              .on("drag", dragmove)
          );

        node
          .append("rect")
          .attr("height", function (d) {
            return d.dy;
          })
          .attr("width", sankey.nodeWidth())
          .style("fill", function (d) {
            return (d.color = color(d.name.replace(/ .*/, "")));
          })
          .style("stroke", function (d) {
            return d3.rgb(d.color).darker(2);
          })
          .append("title")
          .text(function (d) {
            return d.name + "\n" + format(d.value);
          });

        node
          .append("text")
          .attr("x", -6)
          .attr("y", function (d) {
            return d.dy / 2;
          })
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .text(function (d) {
            return d.name;
          })
          .filter(function (d) {
            return d.x < width / 2;
          })
          .attr("x", 6 + sankey.nodeWidth())
          .attr("text-anchor", "start");

        function dragmove(d) {
          d3.select(this).attr(
            "transform",
            "translate(" +
              d.x +
              "," +
              (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) +
              ")"
          );
          sankey.relayout();
          link.attr("d", path);
        }
      });
    </script>
  </body>
</html>
